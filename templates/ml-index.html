<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Netease Toolkit</title>
    <link rel="icon" href="{{ url_for('static', filename='Circle-icons-music.ico') }}" type="image/x-icon">
    <link href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Task Manager Toggle Button -->
    <button type="button" id="task-manager-toggle" class="btn btn-primary position-fixed shadow d-flex align-items-center justify-content-center"
            style="top: 15px; left: 15px; width: 50px; height: 50px; z-index: 1060; border-radius: 12px;"
            title="ä¸‹è½½ä»»åŠ¡">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        <span id="task-manager-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
    </button>

    <!-- Task Manager Panel -->
    <div id="task-manager-panel" class="position-fixed d-none" style="top: 0; left: 0; width: 360px; height: 100vh; z-index: 1055; background: #fff; box-shadow: 4px 0 20px rgba(0,0,0,0.15); overflow-y: auto;">
        <div class="task-manager-header d-flex justify-content-between align-items-center p-3 border-bottom" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: #fff;">
            <h5 class="mb-0 fw-bold">ä¸‹è½½ä»»åŠ¡</h5>
            <button type="button" id="task-manager-close" class="btn-close btn-close-white" aria-label="Close"></button>
        </div>

        <!-- Active Tasks Section -->
        <div class="task-section p-3 border-bottom">
            <div class="d-flex align-items-center mb-2">
                <span class="badge bg-primary me-2">è¿›è¡Œä¸­</span>
                <span class="task-count text-muted small" id="active-task-count">0</span>
            </div>
            <div id="active-tasks" class="task-list"></div>
            <div id="active-tasks-empty" class="text-muted small text-center py-3">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</div>
        </div>

        <!-- Waiting/Paused Tasks Section -->
        <div class="task-section p-3 border-bottom">
            <div class="d-flex align-items-center mb-2">
                <span class="badge bg-warning text-dark me-2">ç­‰å¾…ä¸­</span>
                <span class="task-count text-muted small" id="waiting-task-count">0</span>
            </div>
            <div id="waiting-tasks" class="task-list"></div>
            <div id="waiting-tasks-empty" class="text-muted small text-center py-3">æš‚æ— ç­‰å¾…ä¸­çš„ä»»åŠ¡</div>
        </div>

        <!-- Completed Tasks Section -->
        <div class="task-section p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div>
                    <span class="badge bg-success me-2">å·²å®Œæˆ</span>
                    <span class="task-count text-muted small" id="completed-task-count">0</span>
                </div>
                <button type="button" id="clear-completed-tasks" class="btn btn-outline-secondary btn-sm" title="æ¸…ç©ºå·²å®Œæˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            </div>
            <div id="completed-tasks" class="task-list"></div>
            <div id="completed-tasks-empty" class="text-muted small text-center py-3">æš‚æ— å·²å®Œæˆçš„ä»»åŠ¡</div>
        </div>
    </div>

    <!-- Task Manager Overlay -->
    <div id="task-manager-overlay" class="position-fixed d-none" style="top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1054;"></div>

    <div class="container mt-5 flex-grow-1">
        <h1 class="text-center mb-4">ML Netease Toolkit</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="main-form">
                    <div class="mb-3">
                        <!-- Settings moved to Modal -->

                        <!-- åŠŸèƒ½é€‰æ‹©æ ‡ç­¾é¡µ -->
                        <div class="border-bottom mb-4">
                            <nav class="d-flex flex-row" aria-label="åŠŸèƒ½é€‰æ‹©">
                                <a href="#" id="tab-search" data-mode="search"
                                   class="tab-item border-bottom border-primary text-primary fw-bold px-3 py-2 me-2 text-decoration-none"
                                   aria-current="page">æ­Œæ›²æœç´¢</a>
                                <a href="#" id="tab-parse" data-mode="parse"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 me-2 text-decoration-none">å•æ›²è§£æ</a>
                                <a href="#" id="tab-playlist" data-mode="playlist"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 me-2 text-decoration-none">æ­Œå•è§£æ</a>
                                <a href="#" id="tab-album" data-mode="album"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 text-decoration-none">ä¸“è¾‘è§£æ</a>
                            </nav>
                        </div>
                    </div>
                    <!-- æ­Œæ›²æœç´¢åŒºåŸŸ -->
                    <div id="mode-content-search" class="mode-content">
                        <div id="search-area">
                            <div class="mb-3">
                                <label for="search_keywords" class="form-label">æœç´¢å…³é”®è¯</label>
                                <input type="text" id="search_keywords" class="form-control" placeholder="è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢">
                            </div>
                            <div class="text-center">
                                <button type="button" id="search-btn" class="btn btn-success w-50">æœç´¢</button>
                            </div>
                        </div>
                    </div>
                    <!-- å•æ›²è§£æåŒºåŸŸ -->
                    <div id="mode-content-parse" class="mode-content d-none">
                        <div id="parse-area">
                            <div class="mb-3">
                                <label for="song_ids" class="form-label">æ­Œæ›²IDæˆ–URL</label>
                                <input type="text" id="song_ids" class="form-control" placeholder="è¾“å…¥æ­Œæ›²IDæˆ–URL">
                            </div>
                            <div class="text-center">
                                <button type="button" id="parse-btn" class="btn btn-primary w-50">è§£æ</button>
                            </div>
                        </div>
                    </div>
                    <!-- æ­Œå•è§£æåŒºåŸŸ -->
                    <div id="mode-content-playlist" class="mode-content d-none">
                        <div id="playlist-area">
                            <div class="mb-3">
                                <label for="playlist_id" class="form-label">æ­Œå•IDæˆ–é“¾æ¥</label>
                                <input type="text" id="playlist_id" class="form-control" placeholder="è¾“å…¥æ­Œå•IDæˆ–ç½‘æ˜“äº‘æ­Œå•é“¾æ¥">
                            </div>
                            <div class="text-center">
                                <button type="button" id="playlist-btn" class="btn btn-warning w-50">è§£ææ­Œå•</button>
                            </div>
                        </div>
                    </div>
                    <!-- ä¸“è¾‘è§£æåŒºåŸŸ -->
                    <div id="mode-content-album" class="mode-content d-none">
                        <div id="album-area">
                            <div class="mb-3">
                                <label for="album_id" class="form-label">ä¸“è¾‘IDæˆ–é“¾æ¥</label>
                                <input type="text" id="album_id" class="form-control" placeholder="è¾“å…¥ä¸“è¾‘IDæˆ–ç½‘æ˜“äº‘ä¸“è¾‘é“¾æ¥">
                            </div>
                            <div class="text-center">
                                <button type="button" id="album-btn" class="btn btn-info w-50">è§£æä¸“è¾‘</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- APlayer Area -->
        <div class="row g-0">
            <div class="col-12 p-3 pt-0">
                <div id="aplayer"></div>
            </div>
        </div>
        <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
        <div id="search-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">æœç´¢ç»“æœ</h5>
                    <div class="button-container d-flex flex-wrap gap-2 align-items-center mb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(false)">å–æ¶ˆé€‰æ‹©</button>
                        <div class="vr mx-2"></div>
                        <button id="download_all_MusicButton_search" class="btn btn-primary btn-sm">ä¸‹è½½é€‰ä¸­</button>
                        <button id="play_all_search" class="btn btn-primary btn-sm" disabled>åŠ å…¥æ’­æ”¾åˆ—è¡¨</button>
                    </div>
                </div>
                <ul class="list-group list-group-flush" id="search-list"></ul>
            </div>
        </div>
        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="song-info" class="alert alert-info d-none mt-4 p-0 border-0" style="box-shadow:0 2px 8px rgba(0,0,0,0.07);">
            <div class="row g-0 align-items-stretch">
                <div class="col-md-8 p-3 d-flex flex-column justify-content-between">
                    <h4 class="mb-2" id="song_name" style="font-weight:700;"></h4>
                    <button id="downloadMusicButton" class="btn btn-primary mt-3">ä¸‹è½½(å¹¶å†™å…¥å…ƒæ•°æ®)</button>
                    <div class="mb-2"><span class="badge bg-primary me-2">æ­Œæ‰‹</span><span id="artist_names"></span></div>
                    <div class="mb-2"><span class="badge bg-secondary me-2">ä¸“è¾‘</span><span id="song_alname"></span></div>
                    <div class="mb-2"><span class="badge bg-success me-2">éŸ³è´¨</span><span id="song_level"></span></div>
                    <div class="mb-2"><span class="badge bg-warning text-dark me-2">å¤§å°</span><span id="song_size"></span></div>
                    <div class="mb-2">
                        <button id="show-big-pic" type="button" class="btn btn-outline-info btn-sm me-2" style="vertical-align:middle;">æ˜¾ç¤ºå¤§å›¾</button>
                    </div>
                    <div class="mb-2"><span class="badge bg-info text-dark me-2">é“¾æ¥</span><a id="song_url" href="" target="_blank">ç‚¹å‡»ä¸‹è½½éŸ³é¢‘</a></div>
                    <div class="mb-2"><span class="badge bg-dark me-2">æ­Œè¯</span></div>
                    <div class="lyric-box" id="lyric"></div>
                </div>
            </div>
        </div>
        <!-- æ­Œå•è§£æç»“æœ -->
        <div id="playlist-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="playlist-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div>
                            <h5 id="playlist-name" class="mb-1"></h5>
                            <div class="text-muted" id="playlist-creator"></div>
                        </div>
                    </div>
                    <div id="playlist-desc" class="mb-2 text-secondary small"></div>
                    <div>å…± <span id="playlist-count"></span> é¦–æ­Œ</div>
                    <div class="button-container d-flex flex-wrap gap-2 align-items-center mb-3 mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(false)">å–æ¶ˆé€‰æ‹©</button>
                        <div class="vr mx-2"></div>
                        <button id="download_all_MusicButton_playlist" class="btn btn-primary btn-sm">ä¸‹è½½é€‰ä¸­</button>
                        <button id="play_all_playlist" class="btn btn-primary btn-sm" disabled>åŠ å…¥æ’­æ”¾åˆ—è¡¨</button>
                    </div>
                    </div>
                <ul class="list-group list-group-flush" id="playlist-tracks"></ul>
            </div>
        </div>
        <!-- ä¸“è¾‘è§£æç»“æœ -->
        <div id="album-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="album-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div>
                            <h5 id="album-name" class="mb-1"></h5>
                            <div class="text-muted" id="album-artist"></div>
                        </div>
                    </div>
                    <div id="album-desc" class="mb-2 text-secondary small"></div>
                    <div>å…± <span id="album-count"></span> é¦–æ­Œ</div>
                    <div class="button-container d-flex flex-wrap gap-2 align-items-center mb-3 mt-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(true)">å…¨é€‰</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="ml_toggle_select_all(false)">å–æ¶ˆé€‰æ‹©</button>
                        <div class="vr mx-2"></div>
                        <button id="download_all_MusicButton_album" class="btn btn-primary btn-sm">ä¸‹è½½é€‰ä¸­</button>
                        <button id="play_all_album" class="btn btn-primary btn-sm" disabled>åŠ å…¥æ’­æ”¾åˆ—è¡¨</button>
                    </div>
                    </div>
                <ul class="list-group list-group-flush" id="album-tracks"></ul>
            </div>
        </div>
    </div>
    <!-- Modal for big picture -->
    <div class="modal fade" id="bigPicModal" tabindex="-1" aria-labelledby="bigPicModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bigPicModalLabel">å¤§å›¾é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="big-pic-img" src="" alt="å¤§å›¾" style="max-width:100%;max-height:60vh;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button type="button" class="btn btn-secondary position-fixed bottom-0 start-0 m-3 rounded-circle shadow d-flex align-items-center justify-content-center"
            style="width: 50px; height: 50px; z-index: 1050;"
            data-bs-toggle="modal" data-bs-target="#settingsModal" title="è®¾ç½®">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
            <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.86z"/>
        </svg>
    </button>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="level" class="form-label">éŸ³è´¨é€‰æ‹©</label>
                                <select id="level" class="form-select">
                                    <option value="standard">æ ‡å‡†éŸ³è´¨</option>
                                    <option value="exhigh">æé«˜éŸ³è´¨</option>
                                    <option value="lossless">æ— æŸéŸ³è´¨</option>
                                    <option value="hires">HireséŸ³è´¨</option>
                                    <option value="sky">æ²‰æµ¸ç¯ç»•å£°</option>
                                    <option value="jyeffect">é«˜æ¸…ç¯ç»•å£°</option>
                                    <option value="jymaster">è¶…æ¸…æ¯å¸¦</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="search_limit" class="form-label">æœç´¢è¿”å›æ•°é‡</label>
                                <input type="number" id="search_limit" class="form-control" value="10" min="3" max="100">
                            </div>
                            <div class="col-md-3">
                                <label for="concurrent-downloads" class="form-label">æœ€å¤§åŒæ—¶ä¸‹è½½æ•°</label>
                                <input type="number" id="concurrent-downloads" class="form-control" value="3" min="1" max="10">
                            </div>
                            <!-- æœ€å¤§ä»»åŠ¡æ•°è®¾ç½®å·²æ³¨é‡Š
                            <div class="col-md-3">
                                <label for="max-download-tasks" class="form-label small">æœ€å¤§ä»»åŠ¡æ•°</label>
                                <input type="number" id="max-download-tasks" class="form-control form-control-sm" value="3" min="1" max="10">
                            </div>
                            -->
                        </div>

                        <!-- è‡ªå®šä¹‰æ–‡ä»¶åæ ¼å¼åŒºåŸŸ -->
                        <div class="card border-0 shadow-sm" style="background-color: #f8f9fa;">
                            <div class="card-header bg-transparent border-0 p-3">
                                <h6 class="card-title fw-bold text-primary mb-0 d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sliders me-2" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"/>
                                    </svg>è‡ªå®šä¹‰æ–‡ä»¶åæ ¼å¼
                                </h6>
                            </div>

                            <div class="card-body p-3 pt-0">
                                <div class="input-group mb-3 shadow-sm">
                                    <span class="input-group-text bg-white border-end-0 text-muted">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                            <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"/>
                                        </svg>
                                    </span>
                                    <input type="text" id="filename-template" class="form-control border-start-0 border-end-0 ps-0" placeholder="é»˜è®¤ï¼š${title}_${artist}_${album}">
                                    <button class="btn btn-outline-secondary bg-white text-muted border-start-0" type="button" id="clear-filename-template" title="æ¸…ç©º">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                                        </svg>
                                    </button>
                                </div>

                                <div class="row g-2 align-items-center mb-2">
                                    <!-- å˜é‡æ’å…¥ -->
                                    <div class="col-12 col-md-auto">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-secondary me-2 fw-normal" style="min-width: 45px;">å˜é‡</span>
                                            <div class="btn-group btn-group-sm shadow-sm">
                                                <button type="button" class="btn btn-outline-secondary bg-white filename-variable" data-value="${title}">æ­Œæ›²å</button>
                                                <button type="button" class="btn btn-outline-secondary bg-white filename-variable" data-value="${artist}">æ­Œæ‰‹</button>
                                                <button type="button" class="btn btn-outline-secondary bg-white filename-variable" data-value="${album}">ä¸“è¾‘</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- åˆ†éš”ç¬¦é€‰æ‹© -->
                                    <div class="col-12 col-md-auto ms-md-auto">
                                        <div class="d-flex align-items-center bg-white rounded border px-2 py-1 shadow-sm">
                                            <small class="text-muted me-2 user-select-none" style="font-size: 0.85rem;">åˆ†éš”ç¬¦</small>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <input type="radio" class="btn-check" name="separator-type" id="sep-underscore" value="_" checked>
                                                <label class="btn btn-outline-light text-dark border-0 px-2 py-0 fw-bold position-relative" for="sep-underscore" style="line-height: 1.5; transition: all 0.2s;">
                                                    <span class="d-inline-block" style="transform: translateY(-1px);">_</span>
                                                </label>

                                                <div class="vr my-1 text-muted opacity-25"></div>

                                                <input type="radio" class="btn-check" name="separator-type" id="sep-hyphen" value="-">
                                                <label class="btn btn-outline-light text-dark border-0 px-2 py-0 fw-bold position-relative" for="sep-hyphen" style="line-height: 1.5; transition: all 0.2s;">
                                                    <span class="d-inline-block">-</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¸¸ç”¨é¢„è®¾ -->
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                    <span class="badge bg-info text-dark me-0 fw-normal" style="min-width: 45px;">é¢„è®¾</span>
                                    <button type="button" class="btn btn-sm btn-outline-info bg-white border filename-preset shadow-sm" data-keys="title,artist,album" data-value="${title}_${artist}_${album}">æ­Œå_æ­Œæ‰‹_ä¸“è¾‘</button>
                                    <button type="button" class="btn btn-sm btn-outline-info bg-white border filename-preset shadow-sm" data-keys="title,artist" data-value="${title}_${artist}">æ­Œå_æ­Œæ‰‹</button>
                                    <button type="button" class="btn btn-sm btn-outline-info bg-white border filename-preset shadow-sm" data-keys="artist,title" data-value="${artist}_${title}">æ­Œæ‰‹_æ­Œå</button>
                                    <button type="button" class="btn btn-sm btn-outline-info bg-white border filename-preset shadow-sm" data-keys="title" data-value="${title}">ä»…æ­Œå</button>
                                </div>

                                <!-- é¢„è§ˆåŒºåŸŸ -->
                                <div class="p-2 rounded" style="background-color: #e7f1ff; border-left: 4px solid #0d6efd;">
                                    <div class="d-flex align-items-center small text-primary">
                                        <span class="me-2 fw-bold">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-fill me-1" viewBox="0 0 16 16">
                                                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                                            </svg>é¢„è§ˆ:
                                        </span>
                                        <span id="filename-preview" class="font-monospace text-dark fw-bold"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    <!-- è‡ªå®šä¹‰è­¦å‘Šå¯¹è¯æ¡† -->
    <div class="ml-overlay" id="ml_overlay"></div>
    <div class="custom-alert" id="ml_Alert_region">
        <div class="custom-alert-header" id="ml_Alert_Header">
            <h3 class="custom-alert-title" id="ml_Alert_Title">æç¤º</h3>
            <button class="custom-alert-close" onclick="ml_hide_Alert()">&times;</button>
        </div>
        <div class="custom-alert-content">
            <p class="custom-alert-message" id="ml_Alert_Message"></p>
        </div>
        <div class="custom-alert-footer">
            <button class="custom-alert-button custom-alert-cancel d-none" id="ml_Alert_Cancel">å–æ¶ˆ</button>
            <button class="custom-alert-button" id="ml_Alert_Confirm">ç¡®å®š</button>
        </div>
    </div>
    <footer class="footer mt-5 py-3 bg-light border-top">
        <div class="container text-center text-muted small">
            <span><a href="https://github.com/midairlogn/ML-Netease_url" target="_blank">ML Netease Toolkit</a> &copy; 2026 | GPLv3 LICENSE | Presented by <a href="https://github.com/midairlogn" target="_blank">Midairlogn</a></span>
        </div>
    </footer>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script> -->
    <script src="{{ url_for('static', filename='ml-APlayer.min.js') }}"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥ id3-writer åº“ -->
    <script type="module">
        import { ID3Writer } from 'https://egoroof.github.io/browser-id3-writer/js/browser-id3-writer.6.0.0.mjs';
        window.ID3Writer = ID3Writer;
    </script>

    <!-- å¼•å…¥ ml ä¸‹è½½å‡½æ•° (./ml-js-plugins/ml-func-plugins.js) -->
    <script src="{{ url_for('static', filename='ml-flac-writer.js') }}"></script>
    <script src="{{ url_for('static', filename='ml-func-plugins.js') }}"></script>
    <script src="{{ url_for('static', filename='ml-task-manager.js') }}"></script>

    <!-- è‡ªå®šä¹‰å¼¹çª—å‡½æ•° -->
    <script>
        // ç”¨äºå­˜å‚¨confirmå›è°ƒ
        var ml_confirm_resolve = null;

        // æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—ï¼ˆä»…ç¡®å®šæŒ‰é’®ï¼‰
        // type: 'info' (é»˜è®¤), 'success', 'error', 'warning'
        function ml_show_Alert(title, message, type = 'info') {
            document.getElementById('ml_Alert_Title').textContent = title;
            document.getElementById('ml_Alert_Message').textContent = message;

            // è®¾ç½®å¤´éƒ¨æ ·å¼
            const header = document.getElementById('ml_Alert_Header');
            header.classList.remove('success', 'error', 'warning');
            if (type !== 'info') {
                header.classList.add(type);
            }

            // éšè—å–æ¶ˆæŒ‰é’®ï¼ˆæ™®é€šå¼¹çª—åªéœ€ç¡®å®šæŒ‰é’®ï¼‰
            document.getElementById('ml_Alert_Cancel').classList.add('d-none');

            // é‡ç½®å›è°ƒ
            ml_confirm_resolve = null;

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('ml_Alert_region').classList.add('show');
            document.getElementById('ml_overlay').classList.add('show');
        }

        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—ï¼ˆç¡®å®š+å–æ¶ˆæŒ‰é’®ï¼‰ï¼Œè¿”å›Promise
        // type: 'info' (é»˜è®¤), 'warning'
        function ml_show_Confirm(title, message, type = 'warning') {
            return new Promise((resolve) => {
                document.getElementById('ml_Alert_Title').textContent = title;
                document.getElementById('ml_Alert_Message').textContent = message;

                // è®¾ç½®å¤´éƒ¨æ ·å¼
                const header = document.getElementById('ml_Alert_Header');
                header.classList.remove('success', 'error', 'warning');
                if (type !== 'info') {
                    header.classList.add(type);
                }

                // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
                document.getElementById('ml_Alert_Cancel').classList.remove('d-none');

                // å­˜å‚¨å›è°ƒ
                ml_confirm_resolve = resolve;

                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('ml_Alert_region').classList.add('show');
                document.getElementById('ml_overlay').classList.add('show');
            });
        }

        // éšè—è‡ªå®šä¹‰å¼¹çª—
        function ml_hide_Alert(result = false) {
            document.getElementById('ml_Alert_region').classList.remove('show');
            document.getElementById('ml_overlay').classList.remove('show');

            // å¦‚æœæœ‰ç¡®è®¤å›è°ƒï¼Œè°ƒç”¨å®ƒ
            if (ml_confirm_resolve) {
                ml_confirm_resolve(result);
                ml_confirm_resolve = null;
            }
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('ml_Alert_Confirm').addEventListener('click', function() {
            ml_hide_Alert(true);
        });
        document.getElementById('ml_Alert_Cancel').addEventListener('click', function() {
            ml_hide_Alert(false);
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—ï¼ˆè§†ä¸ºå–æ¶ˆï¼‰
        document.getElementById('ml_overlay').addEventListener('click', function() {
            ml_hide_Alert(false);
        });
    </script>

    <script>
        $(document).ready(function() {

            const ap = new APlayer({
                container: document.getElementById('aplayer'),
                lrcType: 1,
                audio: []
            });

            ap.notice('Waiting for audios to be added', 0, 0.8);

            // ç›‘å¬æ’­æ”¾äº‹ä»¶ï¼Œç”¨äºéªŒè¯ URL æ˜¯å¦å·²æ›´æ–°
            ap.on('play', () => {
                const currentSong = ap.list.audios[ap.list.index];
                console.log(`ğŸµ æ­£åœ¨æ’­æ”¾: ${currentSong.name} | URL: ${currentSong.url}`);
            });

            // ç›‘å¬åŠ è½½å¼€å§‹äº‹ä»¶
            ap.on('canplay', () => {
                const currentSong = ap.list.audios[ap.list.index];
                console.log(`âœ… æ­Œæ›²å¯ä»¥æ’­æ”¾: ${currentSong.name} | URL: ${currentSong.url}`);
            });

            // ç›‘å¬é”™è¯¯äº‹ä»¶ï¼Œåªåœ¨æ’­æ”¾å‡ºé”™æ—¶å°è¯•åˆ·æ–° url å¹¶é‡è¯•
            // ç”¨äºç½‘æ˜“äº‘åŠ¨æ€éŸ³ä¹åœ°å€
            ap.on('error', async (e) => {
                const index = ap.list.index;
                const currentSong = ap.list.audios[index];
                if (!currentSong._retried) {
                    console.log(`âŒ æ’­æ”¾é”™è¯¯: ${currentSong.name}ï¼Œå°è¯•åˆ·æ–° URL å¹¶é‡è¯•...\n`, e);
                    ap.pause();
                    document.querySelector('.aplayer-notice').textContent = 'Trying to fetch audio.';
                    document.querySelector('.aplayer-notice').style.opacity = '0.8';
                    ap.audio.onerror = null;
                    ml_song_info_post_url = ml_song_info_post_url_base + '/Song_V1';
                    ml_selected_level = $('#level').val();
                    const response = await $.post(ml_song_info_post_url, { url: currentSong.id, level: ml_selected_level, type: 'json' });
                    if (response && response.url) {
                        currentSong.url = response.url;
                        currentSong._retried = true;
                        ap.audio.src = response.url;
                        ap.audio.load();
                        ap.audio.onerror = () => ap.emit('error', new Error('Audio error'));
                        document.querySelector('.aplayer-notice').style.opacity = '0';
                        // ap.skipBack();
                        // ap.skipForward();
                        ap.play();
                        // console.log(ap.list);
                    } else {
                        console.error('è·å–æ–° URL å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾è¯¥æ­Œæ›²ã€‚');
                    }
                } else {
                    console.error('å·²å°è¯•åˆ·æ–° URLï¼Œä½†ä»æ— æ³•æ’­æ”¾ã€‚');
                }
            });

            console.log('APlayer MLè‡ªå®šä¹‰ç›‘å¬åŠ è½½å®Œæˆ');

            // Tab switching logic
            // Expose activateTab to global scope so it can be called from other event handlers
            window.activateTab = function(selectedMode) {
                const tabItems = document.querySelectorAll('.tab-item');
                const modeContentAreas = document.querySelectorAll('.mode-content');

                // Update Tab Styles
                tabItems.forEach(tab => {
                    const mode = tab.getAttribute('data-mode');
                    if (mode === selectedMode) {
                        tab.classList.add('border-primary', 'text-primary', 'fw-bold');
                        tab.classList.remove('border-transparent', 'text-secondary');
                        tab.setAttribute('aria-current', 'page');
                    } else {
                        tab.classList.remove('border-primary', 'text-primary', 'fw-bold');
                        tab.classList.add('border-transparent', 'text-secondary');
                        tab.removeAttribute('aria-current');
                    }
                });

                // Show/Hide Input Areas
                modeContentAreas.forEach(content => {
                    if (content.id === `mode-content-${selectedMode}`) {
                        content.classList.remove('d-none');
                    } else {
                        content.classList.add('d-none');
                    }
                });

                // Hide ALL Result Areas when switching tabs
                $('#search-result, #song-info, #playlist-result, #album-result').addClass('d-none');
            };

            // Bind click events to tabs
            const tabItems = document.querySelectorAll('.tab-item');
            tabItems.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const selectedMode = tab.getAttribute('data-mode');
                    window.activateTab(selectedMode);
                });
            });

            // Initialize default tab
            window.activateTab('search');

            // ç›‘å¬å¹¶è¡Œä¸‹è½½æ•°è¾“å…¥
            $('#concurrent-downloads').on('change blur', function() {
                let val = parseInt($(this).val());
                const min = parseInt($(this).attr('min'));
                const max = parseInt($(this).attr('max'));
                if (isNaN(val) || val < min) {
                    val = min;
                } else if (val > max) {
                    val = max;
                }
                $(this).val(val);
            });

            // ç›‘å¬æœç´¢è¿”å›æ•°é‡è¾“å…¥
            $('#search_limit').on('change blur', function() {
                let val = parseInt($(this).val());
                const min = parseInt($(this).attr('min'));
                const max = parseInt($(this).attr('max'));
                if (isNaN(val) || val < min) {
                    val = min;
                } else if (val > max) {
                    val = max;
                }
                $(this).val(val);
            });

            // æœç´¢åŠŸèƒ½
            $('#search-btn').on('click', function() {
                const $btn = $(this);
                const keywords = $('#search_keywords').val();
                const limit = $('#search_limit').val();
                ml_search_real_url = ml_song_info_post_url_base + '/Search';
                if (!keywords) {
                    ml_show_Alert('æç¤º', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                    return;
                }
                // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                ml_set_button_state('#search-btn', true, 'æœç´¢ä¸­...');

                $.ajax({
                    url: ml_search_real_url,
                    method: 'GET',
                    data: { keywords: keywords, limit: limit },
                    dataType: 'json',
                    success: function(data) {
                        console.log("æœç´¢åŠŸèƒ½");
                        console.log(data);
                        if (data.status === 200 && data.result.length > 0) {
                            ml_song_list.length = 0;
                            $('#search-list').empty();
                            data.result.forEach(function(song) {
                                const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <input type="checkbox" class="song-checkbox form-check-input me-3" data-id="${song.id}" checked>
                                        <img src="${song.picUrl}" alt="cover" style="width:40px;height:40px;object-fit:cover;border-radius:4px;margin-right:10px;">
                                        <div>
                                            <strong class='song-title'>${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è¯¦æƒ…</button>
                                </li>`;
                                ml_song_list.push(song);
                                $('#search-list').append(item);
                            });
                            $('#search-result').removeClass('d-none');

                            // æ˜¾ç¤ºæœç´¢æˆåŠŸé€šçŸ¥
                            ml_show_search_success_toast(data.result.length);

                            // Initialize button state
                            ml_update_action_buttons_state();

                            // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            $('#download_all_MusicButton_search').off('click').on('click', function() {
                                ml_apply_download_cooldown(this);
                                const selectedSongs = ml_get_selected_songs();
                                if (selectedSongs.length === 0) {
                                    ml_show_Alert('æç¤º', 'è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ­Œæ›²', 'warning');
                                    return;
                                }
                                ml_add_batch_task(selectedSongs, 'æœç´¢ç»“æœ', `${selectedSongs.length} é¦–æ­Œæ›²`, selectedSongs[0]?.picUrl || '', $('#level').val());
                            });
                            // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            $('#play_all_search').off('click').on('click', function() {
                                const selectedSongs = ml_get_selected_songs();
                                add_songs_to_aplayer(selectedSongs, $('#level').val());
                            });
                        } else {
                            $('#search-list').html('<li class="list-group-item">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</li>');
                            $('#search-result').removeClass('d-none');
                        }
                    },
                    error: function() {
                        $('#search-list').html('<li class="list-group-item">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</li>');
                        $('#search-result').removeClass('d-none');
                    },
                    complete: function() {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        ml_set_button_state('#search-btn', false);
                    }
                });
            });

            // æœç´¢ç»“æœç‚¹å‡»è§£æ
            $(document).on('click', '.select-song', function() {
                const songId = $(this).data('id');
                $('#song_ids').val(songId);

                // Explicitly hide all result containers immediately to ensure clean transition
                $('#search-result, #song-info, #playlist-result, #album-result').addClass('d-none');

                // Switch to parse tab and hide existing results
                window.activateTab('parse');

                $('html,body').animate({scrollTop: $('#main-form').offset().top}, 300);

                // è‡ªåŠ¨è§¦å‘è§£æ
                // ä½¿ç”¨ setTimeout ç¡®ä¿ tab åˆ‡æ¢å’ŒåŠ¨ç”»å¼€å§‹åå†è§¦å‘ï¼Œä½“éªŒæ›´å¥½
                setTimeout(() => {
                    $('#parse-btn').click();
                }, 100);
            });

            // å•æ›²è§£æ
            $('#parse-btn').on('click', function() {
                const songIds = $('#song_ids').val();
                const level = $('#level').val();
                ml_get_song_info_real_url = ml_song_info_post_url_base + '/Song_V1';
                if (!songIds) {
                    ml_show_Alert('æç¤º', 'è¯·è¾“å…¥æ­Œæ›²IDæˆ–URL', 'warning');
                    return;
                }
                // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                ml_set_button_state('#parse-btn', true, 'è§£æä¸­...');

                $.post(ml_get_song_info_real_url, { url: songIds, level: level, type:'json' }, function(data) {
                    console.log("å•æ›²è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        $('#song_name').text(data.name);
                        $('#artist_names').text(data.ar_name);
                        $('#song_alname').text(data.al_name);
                        $('#song_level').text(data.level);
                        $('#song_size').text(data.size);
                        let processedLyrics = data.lyric;
                        if (data.tlyric) {
                            processedLyrics = lrctran(data.lyric, data.tlyric);
                        }
                        $('#lyric').html(processedLyrics.replace(/\n/g, '<br>'));
                        // æ ¹æ®éŸ³è´¨çº§åˆ«ç¡®å®šé“¾æ¥æ–‡æœ¬
                        const mp3Levels = ['standard', 'exhigh'];
                        const linkText = mp3Levels.includes(level) ? 'ç‚¹å‡»ä¸‹è½½ mp3' : 'ç‚¹å‡»ä¸‹è½½ flac';
                        $('#song_url').attr('href', data.url).text(linkText);
                        $('#song-info').removeClass('d-none');
                        $('#show-big-pic').data('pic', data.pic);

                        // æ˜¾ç¤ºå•æ›²è§£ææˆåŠŸé€šçŸ¥
                        ml_show_parse_success_toast(data.name, data.ar_name, data.pic);

                        // Fix: Do not clear playlist, append to end if not duplicate
                        // ap.list.clear();

                        ml_first_song_detailed_info = {
                            id: data.id,
                            name: data.name,
                            artist: data.ar_name,
                            url: data.url,
                            cover: data.pic,
                            lrc: processedLyrics
                        };

                        // Check for duplicates
                        const existingIds = ap.list.audios.map(a => a.id);
                        // Convert to string for comparison just in case
                        const isDuplicate = existingIds.some(id => String(id) === String(data.id));

                        if (!isDuplicate) {
                            ap.list.add(ml_first_song_detailed_info);
                            console.log(`æ­Œæ›² ${data.name} å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨æœ«å°¾`);
                        } else {
                            console.log(`æ­Œæ›² ${data.name} å·²å­˜åœ¨äºæ’­æ”¾åˆ—è¡¨ï¼Œè·³è¿‡æ·»åŠ `);
                        }

                        document.querySelector('.aplayer-notice').style.opacity = '0';
                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#downloadMusicButton').off('click').on('click', function() {
                            ml_apply_download_cooldown(this);
                            const songData = {
                                id: data.id,
                                name: data.name,
                                ar_name: data.ar_name,
                                al_name: data.al_name,
                                pic: data.pic,
                                picUrl: data.pic,
                                artists: data.ar_name
                            };
                            ml_add_single_song_task(songData, level);
                        });
                    } else {
                        ml_show_Alert('è§£æå¤±è´¥', data.msg, 'error');
                    }
                }, 'json').always(function() {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    ml_set_button_state('#parse-btn', false);
                });
            });

            // æ˜¾ç¤ºå¤§å›¾æŒ‰é’®äº‹ä»¶
            $(document).on('click', '#show-big-pic', function() {
                var picUrl = $(this).data('pic');
                $('#big-pic-img').attr('src', picUrl);
                var modal = new bootstrap.Modal(document.getElementById('bigPicModal'));
                modal.show();
            });

            // æ­Œå•è§£æ
            $('#playlist-btn').on('click', function() {
                let pid = $('#playlist_id').val().trim();
                ml_get_playlist_real_url = ml_song_info_post_url_base + '/Playlist';
                if (!pid) {
                    ml_show_Alert('æç¤º', 'è¯·è¾“å…¥æ­Œå•IDæˆ–é“¾æ¥', 'warning');
                    return;
                }
                // æ”¯æŒç›´æ¥ç²˜è´´æ­Œå•é“¾æ¥
                const idMatch = pid.match(/playlist\?id=(\d+)/);
                if (idMatch) pid = idMatch[1];

                // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                ml_set_button_state('#playlist-btn', true, 'è§£æä¸­...');

                $.get(ml_get_playlist_real_url, { id: pid }, function(data) {
                    console.log("æ­Œå•è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        ml_song_list.length = 0;
                        const pl = data.playlist;
                        $('#playlist-cover').attr('src', pl.coverImgUrl);
                        $('#playlist-name').text(pl.name);
                        $('#playlist-creator').text('by ' + pl.creator);
                        $('#playlist-desc').text(pl.description || '');
                        $('#playlist-count').text(pl.trackCount);
                        $('#playlist-tracks').empty();
                        pl.tracks.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="song-checkbox form-check-input me-3" data-id="${song.id}" checked>
                                    <img src="${song.picUrl}" alt="cover" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è¯¦æƒ…</button>
                            </li>`;
                            ml_song_list.push(song);
                            $('#playlist-tracks').append(item);
                        });
                        $('#playlist-result').removeClass('d-none');

                        // æ˜¾ç¤ºæ­Œå•è§£ææˆåŠŸé€šçŸ¥
                        ml_show_playlist_success_toast(pl.name, pl.trackCount, pl.coverImgUrl);

                        // Initialize button state
                        ml_update_action_buttons_state();

                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#download_all_MusicButton_playlist').off('click').on('click', function() {
                            ml_apply_download_cooldown(this);
                            const selectedSongs = ml_get_selected_songs();
                            if (selectedSongs.length === 0) {
                                ml_show_Alert('æç¤º', 'è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ­Œæ›²', 'warning');
                                return;
                            }
                            const playlistName = $('#playlist-name').text();
                            const playlistDesc = $('#playlist-desc').text();
                            const playlistCover = $('#playlist-cover').attr('src');
                            ml_add_batch_task(selectedSongs, playlistName, playlistDesc || `${selectedSongs.length} é¦–æ­Œæ›²`, playlistCover, $('#level').val());
                        });
                        // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#play_all_playlist').off('click').on('click', function() {
                            const selectedSongs = ml_get_selected_songs();
                            add_songs_to_aplayer(selectedSongs, $('#level').val());
                        });
                    } else {
                        $('#playlist-result').removeClass('d-none');
                        $('#playlist-tracks').html('<li class="list-group-item">æ­Œå•è§£æå¤±è´¥ï¼š'+data.msg+'</li>');
                    }
                }, 'json').always(function() {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    ml_set_button_state('#playlist-btn', false);
                });
            });

            // ä¸“è¾‘è§£æ
            $(document).on('click', '#album-btn', function() {
                let aid = $('#album_id').val().trim();
                ml_get_album_real_url = ml_song_info_post_url_base + '/Album';
                if (!aid) {
                    ml_show_Alert('æç¤º', 'è¯·è¾“å…¥ä¸“è¾‘IDæˆ–é“¾æ¥', 'warning');
                    return;
                }
                // æ”¯æŒç›´æ¥ç²˜è´´ä¸“è¾‘é“¾æ¥
                const idMatch = aid.match(/album\?id=(\d+)/);
                if (idMatch) aid = idMatch[1];

                // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                ml_set_button_state('#album-btn', true, 'è§£æä¸­...');

                $.get(ml_get_album_real_url, { id: aid }, function(data) {
                    console.log("ä¸“è¾‘è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        ml_song_list.length = 0;
                        const al = data.album;
                        $('#album-cover').attr('src', al.coverImgUrl);
                        $('#album-name').text(al.name);
                        $('#album-artist').text(al.artist);
                        $('#album-desc').text(al.description || '');
                        $('#album-count').text(al.songs.length);
                        $('#album-tracks').empty();
                        al.songs.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="song-checkbox form-check-input me-3" data-id="${song.id}" checked>
                                    <img src="${song.picUrl}" alt="cover" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è¯¦æƒ…</button>
                            </li>`;
                            ml_song_list.push(song);
                            $('#album-tracks').append(item);
                        });
                        $('#album-result').removeClass('d-none');

                        // æ˜¾ç¤ºä¸“è¾‘è§£ææˆåŠŸé€šçŸ¥
                        ml_show_album_success_toast(al.name, al.artist, al.songs.length, al.coverImgUrl);

                        // Initialize button state
                        ml_update_action_buttons_state();

                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#download_all_MusicButton_album').off('click').on('click', function() {
                            ml_apply_download_cooldown(this);
                            const selectedSongs = ml_get_selected_songs();
                            if (selectedSongs.length === 0) {
                                ml_show_Alert('æç¤º', 'è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ­Œæ›²', 'warning');
                                return;
                            }
                            const albumName = $('#album-name').text();
                            const albumDesc = $('#album-desc').text();
                            const albumCover = $('#album-cover').attr('src');
                            ml_add_batch_task(selectedSongs, albumName, albumDesc || `${selectedSongs.length} é¦–æ­Œæ›²`, albumCover, $('#level').val());
                        });
                        // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#play_all_album').off('click').on('click', function() {
                            const selectedSongs = ml_get_selected_songs();
                            add_songs_to_aplayer(selectedSongs, $('#level').val());
                        });
                    } else {
                        $('#album-result').removeClass('d-none');
                        $('#album-tracks').html('<li class="list-group-item">ä¸“è¾‘è§£æå¤±è´¥ï¼š'+data.msg+'</li>');
                    }
                }, 'json').always(function() {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    ml_set_button_state('#album-btn', false);
                });
            });
            
            // fetch all detailed info
            // and then add to aplayer playlist
            // first remove all existing songs in playlist
            // æ’­æ”¾çŠ¶æ€ç®¡ç†
            var ml_play_state = {
                isLoading: false
            };

            // Helper: Get selected songs from the active container
            function ml_get_selected_songs() {
                const containerSelector = ml_get_active_result_container();
                if (!containerSelector) return [];

                const selectedIds = [];
                $(`${containerSelector} .song-checkbox:checked`).each(function() {
                    selectedIds.push($(this).data('id'));
                });

                // Filter ml_song_list to find matching songs
                // Note: ID comparison should be loose (==) as data-id might be string while song.id might be int
                return ml_song_list.filter(song => selectedIds.some(id => id == song.id));
            }

            // Helper: Toggle select all
            window.ml_toggle_select_all = function(checked) {
                const containerSelector = ml_get_active_result_container();
                if (containerSelector) {
                    $(`${containerSelector} .song-checkbox`).prop('checked', checked);
                    ml_update_action_buttons_state();
                }
            };

            // Helper: Update action buttons state (enable/disable based on selection)
            function ml_update_action_buttons_state() {
                const containerSelector = ml_get_active_result_container();
                if (!containerSelector) return;

                const hasChecked = $(`${containerSelector} .song-checkbox:checked`).length > 0;
                const $downloadBtn = $(`${containerSelector} [id^="download_all"]`);
                const $playBtn = $(`${containerSelector} [id^="play_all"]`);

                $downloadBtn.prop('disabled', !hasChecked);
                $playBtn.prop('disabled', !hasChecked);
            }

            // Listen for checkbox changes to update button state
            $(document).on('change', '.song-checkbox', function() {
                ml_update_action_buttons_state();
            });

            async function add_songs_to_aplayer(songs_to_add, ml_selected_level){
                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (ml_play_state.isLoading) {
                    console.warn('æ­£åœ¨åŠ è½½æ’­æ”¾åˆ—è¡¨ï¼Œè¯·ç­‰å¾…å®Œæˆã€‚');
                    return;
                }

                if (!songs_to_add || songs_to_add.length === 0) {
                    ml_show_Alert('æç¤º', 'è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„æ­Œæ›²', 'warning');
                    return;
                }

                // è·å–å½“å‰æ´»åŠ¨çš„å®¹å™¨
                const containerSelector = ml_get_active_result_container();
                if (!containerSelector) {
                    console.error('æœªæ‰¾åˆ°æ´»åŠ¨çš„ç»“æœå®¹å™¨');
                    return;
                }

                // è®¾ç½®åŠ è½½çŠ¶æ€
                ml_play_state.isLoading = true;
                ml_set_button_state(`${containerSelector} [id^="play_all"]`, true, 'åŠ è½½ä¸­...');

                try {
                    ap.notice('Started: adding songs to playlist', 3000, 0.8);
                    console.log('Started: adding songs to playlist', songs_to_add);
                    ml_get_song_info_real_url = ml_song_info_post_url_base + '/Song_V1';

                    // Filter out duplicates that are already in the playlist
                    const existingIds = new Set(ap.list.audios.map(a => a.id));
                    const newSongs = songs_to_add.filter(s => !existingIds.has(s.id));

                    if (newSongs.length === 0 && songs_to_add.length > 0) {
                        ap.notice('All selected songs are already in the playlist', 3000, 0.8);
                        console.log('All selected songs are already in the playlist');
                        return;
                    }

                    // If playlist is empty, clear it just in case (though logic above handles it)
                    // Actually, we want to append.

                    let addedCount = 0;

                    for(const song of newSongs){
                        let currentTry = 0;
                        let songAdded = false;
                        let response = null;
                        while(currentTry <= ml_max_try_times && !songAdded){
                            try {
                                console.log(`å°è¯•è·å–æ­Œæ›²ä¿¡æ¯ï¼š${song.name} (å°è¯•æ¬¡æ•°: ${currentTry + 1}/${ml_max_try_times + 1})`);
                                response = await $.post(ml_get_song_info_real_url, { url: song.id, level: ml_selected_level, type: 'json' });
                                if(response.status === 200){
                                    console.log(`æˆåŠŸè·å–æ­Œæ›²ä¿¡æ¯ï¼š${song.name}\n`, response);
                                    songAdded = true;
                                } else {
                                    console.error(`è·å–æ­Œæ›² ${song.name} å¤±è´¥ (å°è¯• ${currentTry + 1}/${ml_max_try_times + 1}): ${response.msg}`);
                                    currentTry++;
                                }
                            } catch(error) {
                                console.error(`è¯·æ±‚æ­Œæ›² ${song.name} æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯æˆ–å¼‚å¸¸ (å°è¯• ${currentTry + 1}/${ml_max_try_times + 1}):`, error);
                                currentTry++;
                            }
                        }
                        if(songAdded && response){
                            let processedLyrics = response.lyric;
                            if(response.tlyric){
                                processedLyrics = lrctran(response.lyric, response.tlyric);
                            }
                            ml_song_detailed = {
                                id: song.id, // Ensure ID is stored for duplicate checking
                                name: response.name,
                                artist: response.ar_name,
                                url: response.url,
                                cover: response.pic,
                                lrc: processedLyrics
                            };
                            ap.list.add(ml_song_detailed);
                            addedCount++;
                            console.log(`æ­Œæ›² ${song.name} å·²æˆåŠŸæ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ã€‚`);
                        } else {
                            console.warn(`æ­Œæ›² ${song.name} è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (${ml_max_try_times + 1} æ¬¡) ä»æœªæˆåŠŸï¼Œå·²è·³è¿‡ã€‚`);
                        }
                    }
                    console.log(ap.list);
                    ap.notice(`Finished: added ${addedCount} songs`, 3000, 0.8);
                    console.log(`Finished: added ${addedCount} songs`);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    ml_play_state.isLoading = false;
                    ml_set_button_state(`${containerSelector} [id^="play_all"]`, false);
                }
            }

            async function add_all_song_info_to_aplayer(ml_selected_level){
                // This function is kept for backward compatibility if needed,
                // but we will mainly use add_songs_to_aplayer
                await add_songs_to_aplayer(ml_song_list, ml_selected_level);
            }
            // å¯é€‰ï¼šsleep è¾…åŠ©å‡½æ•°
            // async function sleep(ms) {
            //     return new Promise(resolve => setTimeout(resolve, ms));
            // }

            // ---------------------------------------------------------
            // Settings persistence (localStorage)
            // ---------------------------------------------------------

            const DEFAULT_FILENAME_TEMPLATE = "${title}_${artist}_${album}";
            const DEFAULT_AUDIO_LEVEL = "standard";
            const DEFAULT_CONCURRENT = "3";
            const DEFAULT_SEARCH_LIMIT = "10";
            const DEFAULT_SEPARATOR = "_";

            // 1. Load settings on startup

            // Audio Level
            let savedLevel = localStorage.getItem('ml_audio_level');
            if (savedLevel === null) {
                savedLevel = DEFAULT_AUDIO_LEVEL;
                localStorage.setItem('ml_audio_level', savedLevel);
            }
            $('#level').val(savedLevel);

            // Concurrent Downloads
            let savedConcurrent = localStorage.getItem('ml_concurrent_downloads');
            if (savedConcurrent === null) {
                savedConcurrent = DEFAULT_CONCURRENT;
                localStorage.setItem('ml_concurrent_downloads', savedConcurrent);
            }
            $('#concurrent-downloads').val(savedConcurrent);

            // Search Limit
            let savedSearchLimit = localStorage.getItem('ml_search_limit');
            if (savedSearchLimit === null) {
                savedSearchLimit = DEFAULT_SEARCH_LIMIT;
                localStorage.setItem('ml_search_limit', savedSearchLimit);
            }
            $('#search_limit').val(savedSearchLimit);

            // Filename Template
            let savedFilenameTemplate = localStorage.getItem('ml_filename_template');
            // Ensure localStorage has a value (Requirement: always have content)
            if (savedFilenameTemplate === null) {
                savedFilenameTemplate = DEFAULT_FILENAME_TEMPLATE;
                localStorage.setItem('ml_filename_template', savedFilenameTemplate);
            }
            // Display logic: If matches default, show empty (placeholder takes over visually)
            if (savedFilenameTemplate === DEFAULT_FILENAME_TEMPLATE) {
                $('#filename-template').val('');
            } else {
                $('#filename-template').val(savedFilenameTemplate);
            }

            // Separator
            let savedSeparator = localStorage.getItem('ml_filename_separator');
            if (savedSeparator === null) {
                savedSeparator = DEFAULT_SEPARATOR;
                localStorage.setItem('ml_filename_separator', savedSeparator);
            }
            $(`input[name="separator-type"][value="${savedSeparator}"]`).prop('checked', true);

            // Trigger updates to ensure UI consistency
            // Note: Triggering change/input will invoke the save listeners below,
            // which effectively re-saves the values we just loaded. This is harmless and ensures consistency.
            $('#level').trigger('change');
            $('#filename-template').trigger('input');
            $('input[name="separator-type"]').trigger('change');

            // 2. Save settings on change
            $('#level').on('change', function() {
                localStorage.setItem('ml_audio_level', $(this).val() || DEFAULT_AUDIO_LEVEL);
            });

            $('#concurrent-downloads').on('change', function() {
                let val = $(this).val();
                if (!val) val = DEFAULT_CONCURRENT; // Use default if empty
                localStorage.setItem('ml_concurrent_downloads', val);
            });

            $('#search_limit').on('change', function() {
                let val = $(this).val();
                if (!val) val = DEFAULT_SEARCH_LIMIT; // Use default if empty
                localStorage.setItem('ml_search_limit', val);
            });

            $('#filename-template').on('input', function() {
                let currentVal = $(this).val();
                if (currentVal === '') {
                    // Store default if empty
                    localStorage.setItem('ml_filename_template', DEFAULT_FILENAME_TEMPLATE);
                } else {
                    localStorage.setItem('ml_filename_template', currentVal);
                }
            });

            // Auto-append variable if fixed value (on blur)
            $('#filename-template').on('blur', function() {
                let currentVal = $(this).val();
                // Check if it contains at least one valid variable
                const hasValidVariable = /\$\{(title|artist|album)\}/.test(currentVal);

                // If not empty and has no valid variables
                if (currentVal !== '' && !hasValidVariable) {
                    const separator = $('input[name="separator-type"]:checked').val() || DEFAULT_SEPARATOR;
                    const newVal = currentVal + separator + "${title}";

                    $(this).val(newVal);
                    // Trigger input to save to localStorage and update preview
                    $(this).trigger('input');
                }
            });

            $('input[name="separator-type"]').on('change', function() {
                localStorage.setItem('ml_filename_separator', $(this).val() || DEFAULT_SEPARATOR);
            });
        });
    </script>
</body>
</html>
