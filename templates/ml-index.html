<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Netease Toolkit</title>
    <link rel="icon" href="{{ url_for('static', filename='Circle-icons-music.ico') }}" type="image/x-icon">
    <link href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 800px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-primary {
            margin-top: 20px;
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .btn-success {
            margin-top: 20px;
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .btn-warning {
            margin-top: 20px;
            background-color: #ffc107;
            border-color: #ffc107;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        #song-info {
            margin-top: 20px;
        }
        #song-info img {
            max-width: 100%;
            border-radius: 8px;
        }
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        /* æ­Œæ›²/æ­Œå•æ ‡é¢˜è¿‡é•¿è‡ªåŠ¨çœç•¥å· */
        .song-title, .playlist-title {
            display: inline-block;
            max-width: 180px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* æ­Œå•åˆ—è¡¨æŒ‰é’®ä¸æ¢è¡Œ */
        .list-group-item .select-song {
            flex-shrink: 0;
            margin-left: 10px;
        }
        /* æ­Œè¯åŒºåŸŸç¾åŒ– */
        .lyric-box {
            max-height: 180px;
            overflow-y: auto;
            background: linear-gradient(90deg,#f7f7fa 60%,#f0f4fa 100%);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            color: #222;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            line-height: 1.7;
            margin-bottom: 0;
        }
    </style>
    <!-- æŒ‰é’®å¹¶æ’æ ·å¼ -->
    <style>
        /* æŒ‰é’®å¹¶æ’ */
        .button-container {
        text-align: center; /* å¯é€‰ï¼šå±…ä¸­æŒ‰é’® */
        }
        .button-inline {
        display: inline-block;
        margin: 5px; /* å¯é€‰ï¼šæ·»åŠ æŒ‰é’®ä¹‹é—´çš„é—´è· */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">ML Netease Toolkit</h1>
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="main-form">
                    <div class="mb-3">
                        <!-- éŸ³è´¨é€‰æ‹©åŒºåŸŸ -->
                        <div class="mb-3">
                            <label for="level" class="form-label">éŸ³è´¨é€‰æ‹©</label>
                            <select id="level" class="form-select">
                                <option value="standard">æ ‡å‡†éŸ³è´¨</option>
                                <option value="exhigh">æé«˜éŸ³è´¨</option>
                                <option value="lossless">æ— æŸéŸ³è´¨</option>
                                <option value="hires">HireséŸ³è´¨</option>
                                <option value="sky">æ²‰æµ¸ç¯ç»•å£°</option>
                                <option value="jyeffect">é«˜æ¸…ç¯ç»•å£°</option>
                                <option value="jymaster">è¶…æ¸…æ¯å¸¦</option>
                            </select>
                        </div>
                        <!-- åŠŸèƒ½é€‰æ‹©æ ‡ç­¾é¡µ -->
                        <div class="border-bottom mb-4">
                            <nav class="d-flex flex-row" aria-label="åŠŸèƒ½é€‰æ‹©">
                                <a href="#" id="tab-search" data-mode="search"
                                   class="tab-item border-bottom border-primary text-primary fw-bold px-3 py-2 me-2 text-decoration-none"
                                   aria-current="page">æ­Œæ›²æœç´¢</a>
                                <a href="#" id="tab-parse" data-mode="parse"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 me-2 text-decoration-none">å•æ›²è§£æ</a>
                                <a href="#" id="tab-playlist" data-mode="playlist"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 me-2 text-decoration-none">æ­Œå•è§£æ</a>
                                <a href="#" id="tab-album" data-mode="album"
                                   class="tab-item border-bottom border-transparent text-secondary px-3 py-2 text-decoration-none">ä¸“è¾‘è§£æ</a>
                            </nav>
                        </div>
                    </div>
                    <!-- æ­Œæ›²æœç´¢åŒºåŸŸ -->
                    <div id="mode-content-search" class="mode-content">
                        <div id="search-area">
                            <div class="mb-3">
                                <label for="search_keywords" class="form-label">æœç´¢å…³é”®è¯</label>
                                <input type="text" id="search_keywords" class="form-control" placeholder="è¾“å…¥å…³é”®è¯è¿›è¡Œæœç´¢">
                            </div>
                            <div class="mb-3">
                                <label for="search_limit" class="form-label">è¿”å›æ•°é‡</label>
                                <input type="number" id="search_limit" class="form-control" value="10" min="1" max="50">
                            </div>
                            <div class="text-center">
                                <button type="button" id="search-btn" class="btn btn-success w-50">æœç´¢</button>
                            </div>
                        </div>
                    </div>
                    <!-- å•æ›²è§£æåŒºåŸŸ -->
                    <div id="mode-content-parse" class="mode-content d-none">
                        <div id="parse-area">
                            <div class="mb-3">
                                <label for="song_ids" class="form-label">æ­Œæ›²IDæˆ–URL</label>
                                <input type="text" id="song_ids" class="form-control" placeholder="è¾“å…¥æ­Œæ›²IDæˆ–URL">
                            </div>
                            <div class="text-center">
                                <button type="button" id="parse-btn" class="btn btn-primary w-50">è§£æ</button>
                            </div>
                        </div>
                    </div>
                    <!-- æ­Œå•è§£æåŒºåŸŸ -->
                    <div id="mode-content-playlist" class="mode-content d-none">
                        <div id="playlist-area">
                            <div class="mb-3">
                                <label for="playlist_id" class="form-label">æ­Œå•IDæˆ–é“¾æ¥</label>
                                <input type="text" id="playlist_id" class="form-control" placeholder="è¾“å…¥æ­Œå•IDæˆ–ç½‘æ˜“äº‘æ­Œå•é“¾æ¥">
                            </div>
                            <div class="text-center">
                                <button type="button" id="playlist-btn" class="btn btn-warning w-50">è§£ææ­Œå•</button>
                            </div>
                        </div>
                    </div>
                    <!-- ä¸“è¾‘è§£æåŒºåŸŸ -->
                    <div id="mode-content-album" class="mode-content d-none">
                        <div id="album-area">
                            <div class="mb-3">
                                <label for="album_id" class="form-label">ä¸“è¾‘IDæˆ–é“¾æ¥</label>
                                <input type="text" id="album_id" class="form-control" placeholder="è¾“å…¥ä¸“è¾‘IDæˆ–ç½‘æ˜“äº‘ä¸“è¾‘é“¾æ¥">
                            </div>
                            <div class="text-center">
                                <button type="button" id="album-btn" class="btn btn-info w-50">è§£æä¸“è¾‘</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- APlayer Area -->
        <div class="row g-0">
            <div class="col-12 p-3 pt-0">
                <div id="aplayer"></div>
            </div>
        </div>
        <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
        <div id="search-result" class="mt-4 d-none">
            <h5>æœç´¢ç»“æœï¼š</h5>
            <div class="button-container">
                <button id="download_all_MusicButton_search" class="btn btn-primary mt-3">Download All</button>
                <button id="play_all_search" class="btn btn-primary mt-3">Play All</button>
            </div>
            <ul class="list-group" id="search-list"></ul>
        </div>
        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="song-info" class="alert alert-info d-none mt-4 p-0 border-0" style="box-shadow:0 2px 8px rgba(0,0,0,0.07);">
            <div class="row g-0 align-items-stretch">
                <div class="col-md-8 p-3 d-flex flex-column justify-content-between">
                    <h4 class="mb-2" id="song_name" style="font-weight:700;"></h4>
                    <button id="downloadMusicButton" class="btn btn-primary mt-3">Download (with ID3 tag)</button>
                    <div class="mb-2"><span class="badge bg-primary me-2">æ­Œæ‰‹</span><span id="artist_names"></span></div>
                    <div class="mb-2"><span class="badge bg-secondary me-2">ä¸“è¾‘</span><span id="song_alname"></span></div>
                    <div class="mb-2"><span class="badge bg-success me-2">éŸ³è´¨</span><span id="song_level"></span></div>
                    <div class="mb-2"><span class="badge bg-warning text-dark me-2">å¤§å°</span><span id="song_size"></span></div>
                    <div class="mb-2">
                        <button id="show-big-pic" type="button" class="btn btn-outline-info btn-sm me-2" style="vertical-align:middle;">æ˜¾ç¤ºå¤§å›¾</button>
                    </div>
                    <div class="mb-2"><span class="badge bg-info text-dark me-2">é“¾æ¥</span><a id="song_url" href="" target="_blank">ç‚¹å‡»ä¸‹è½½mp3</a></div>
                    <div class="mb-2"><span class="badge bg-dark me-2">æ­Œè¯</span></div>
                    <div class="lyric-box" id="lyric"></div>
                </div>
            </div>
        </div>
        <!-- æ­Œå•è§£æç»“æœ -->
        <div id="playlist-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="playlist-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div>
                            <h5 id="playlist-name" class="mb-1"></h5>
                            <div class="text-muted" id="playlist-creator"></div>
                        </div>
                    </div>
                    <div id="playlist-desc" class="mb-2 text-secondary small"></div>
                    <div>å…± <span id="playlist-count"></span> é¦–æ­Œ</div>
                    <div class="button-container">
                        <button id="download_all_MusicButton_playlist" class="btn btn-primary mt-3">Download All</button>
                        <button id="play_all_playlist" class="btn btn-primary mt-3">Play All</button>
                    </div>
                </div>
            </div>
            <ul class="list-group mt-3" id="playlist-tracks"></ul>
        </div>
        <!-- ä¸“è¾‘è§£æç»“æœ -->
        <div id="album-result" class="mt-4 d-none">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img id="album-cover" src="" alt="cover" style="width:60px;height:60px;object-fit:cover;border-radius:8px;margin-right:15px;">
                        <div>
                            <h5 id="album-name" class="mb-1"></h5>
                            <div class="text-muted" id="album-artist"></div>
                        </div>
                    </div>
                    <div id="album-desc" class="mb-2 text-secondary small"></div>
                    <div>å…± <span id="album-count"></span> é¦–æ­Œ</div>
                    <div class="button-container">
                        <button id="download_all_MusicButton_album" class="btn btn-primary mt-3">Download All</button>
                        <button id="play_all_album" class="btn btn-primary mt-3">Play All</button>
                    </div>
                </div>
            </div>
            <ul class="list-group mt-3" id="album-tracks"></ul>
        </div>
    </div>
    <!-- Modal for big picture -->
    <div class="modal fade" id="bigPicModal" tabindex="-1" aria-labelledby="bigPicModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bigPicModalLabel">å¤§å›¾é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="big-pic-img" src="" alt="å¤§å›¾" style="max-width:100%;max-height:60vh;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
                </div>
            </div>
        </div>
    </div>
    <footer class="footer mt-5 py-3 bg-light border-top">
        <div class="container text-center text-muted small">
            <span><a href="https://github.com/midairlogn/ML-Netease_url" target="_blank">ML Netease Toolkit</a> &copy; 2025 | MIT LICENSE | Presented by <a href="https://github.com/midairlogn" target="_blank">Midairlogn</a></span>
        </div>
    </footer>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥ id3-writer åº“ -->
    <script type="module">
        import { ID3Writer } from 'https://egoroof.github.io/browser-id3-writer/js/browser-id3-writer.6.0.0.mjs';
        window.ID3Writer = ID3Writer;
    </script>

    <!-- å¼•å…¥ ml ä¸‹è½½å‡½æ•° (./ml-js-plugins/ml-func-plugins.js) -->
    <script src="{{ url_for('static', filename='ml-func-plugins.js') }}"></script>

    <script>
        $(document).ready(function() {

            const ap = new APlayer({
                container: document.getElementById('aplayer'),
                lrcType: 1,
                audio: []
            });

            ap.notice('Waiting for audios to be added', 0, 0.8);

            // ç›‘å¬æ’­æ”¾äº‹ä»¶ï¼Œç”¨äºéªŒè¯ URL æ˜¯å¦å·²æ›´æ–°
            ap.on('play', () => {
                const currentSong = ap.list.audios[ap.list.index];
                console.log(`ğŸµ æ­£åœ¨æ’­æ”¾: ${currentSong.name} | URL: ${currentSong.url}`);
            });

            // ç›‘å¬åŠ è½½å¼€å§‹äº‹ä»¶
            ap.on('canplay', () => {
                const currentSong = ap.list.audios[ap.list.index];
                console.log(`âœ… æ­Œæ›²å¯ä»¥æ’­æ”¾: ${currentSong.name} | URL: ${currentSong.url}`);
            });

            // ç›‘å¬é”™è¯¯äº‹ä»¶ï¼Œåªåœ¨æ’­æ”¾å‡ºé”™æ—¶å°è¯•åˆ·æ–° url å¹¶é‡è¯•
            // ç”¨äºç½‘æ˜“äº‘åŠ¨æ€éŸ³ä¹åœ°å€
            ap.on('error', async (e) => {
                const index = ap.list.index;
                const currentSong = ap.list.audios[index];
                if (!currentSong._retried) {
                    console.log(`âŒ æ’­æ”¾é”™è¯¯: ${currentSong.name}ï¼Œå°è¯•åˆ·æ–° URL å¹¶é‡è¯•...\n`, e);
                    ap.pause();
                    document.querySelector('.aplayer-notice').textContent = 'Trying to fetch audio.';
                    document.querySelector('.aplayer-notice').style.opacity = '0.8';
                    ap.audio.onerror = null;
                    ml_song_info_post_url = ml_song_info_post_url_base + '/Song_V1';
                    ml_selected_level = $('#level').val();
                    const response = await $.post(ml_song_info_post_url, { url: currentSong.id, level: ml_selected_level, type: 'json' });
                    if (response && response.url) {
                        currentSong.url = response.url;
                        currentSong._retried = true;
                        ap.audio.src = response.url;
                        ap.audio.load();
                        ap.audio.onerror = () => ap.emit('error', new Error('Audio error'));
                        document.querySelector('.aplayer-notice').style.opacity = '0';
                        ap.skipBack();
                        ap.skipForward();
                        ap.play();
                        // console.log(ap.list);
                    } else {
                        console.error('è·å–æ–° URL å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾è¯¥æ­Œæ›²ã€‚');
                    }
                } else {
                    console.error('å·²å°è¯•åˆ·æ–° URLï¼Œä½†ä»æ— æ³•æ’­æ”¾ã€‚');
                }
            });

            console.log('APlayer MLè‡ªå®šä¹‰ç›‘å¬åŠ è½½å®Œæˆ');

            // æ–°æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
            (function() {
                const tabItems = document.querySelectorAll('.tab-item');
                const modeContentAreas = document.querySelectorAll('.mode-content');
                const resultDisplayAreas = document.querySelectorAll('#search-result, #song-info, #playlist-result, #album-result');
                function activateTab(selectedMode) {
                    tabItems.forEach(tab => {
                        const mode = tab.getAttribute('data-mode');
                        if (mode === selectedMode) {
                            tab.classList.add('border-primary', 'text-primary', 'fw-bold');
                            tab.classList.remove('border-transparent', 'text-secondary');
                            tab.setAttribute('aria-current', 'page');
                        } else {
                            tab.classList.remove('border-primary', 'text-primary', 'fw-bold');
                            tab.classList.add('border-transparent', 'text-secondary');
                            tab.removeAttribute('aria-current');
                        }
                    });
                    modeContentAreas.forEach(content => {
                        if (content.id === `mode-content-${selectedMode}`) {
                            content.classList.remove('d-none');
                        } else {
                            content.classList.add('d-none');
                        }
                    });
                    resultDisplayAreas.forEach(area => {
                        area.classList.add('d-none');
                    });
                }
                tabItems.forEach(tab => {
                    tab.addEventListener('click', function(e) {
                        e.preventDefault();
                        const selectedMode = tab.getAttribute('data-mode');
                        activateTab(selectedMode);
                    });
                });
                activateTab('search');
            })();

            // æœç´¢åŠŸèƒ½
            $('#search-btn').on('click', function() {
                const keywords = $('#search_keywords').val();
                const limit = $('#search_limit').val();
                ml_search_real_url = ml_song_info_post_url_base + '/Search';
                if (!keywords) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }
                $.ajax({
                    url: ml_search_real_url,
                    method: 'GET',
                    data: { keywords: keywords, limit: limit },
                    dataType: 'json',
                    success: function(data) {
                        console.log("æœç´¢åŠŸèƒ½");
                        console.log(data);
                        if (data.status === 200 && data.result.length > 0) {
                            ml_song_list.length = 0;
                            $('#search-list').empty();
                            data.result.forEach(function(song) {
                                const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <img src="${song.picUrl}" alt="cover" style="width:40px;height:40px;object-fit:cover;border-radius:4px;margin-right:10px;">
                                        <strong class='song-title'>${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è§£æ</button>
                                </li>`;
                                ml_song_list.push(song);
                                $('#search-list').append(item);
                            });
                            $('#search-result').removeClass('d-none');
                            // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            $('#download_all_MusicButton_search').off('click').on('click', function() {
                                ml_donwload_song_list($('#level').val());
                            });
                            // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                            $('#play_all_search').off('click').on('click', function() {
                                add_all_song_info_to_aplayer($('#level').val());
                            });
                        } else {
                            $('#search-list').html('<li class="list-group-item">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</li>');
                            $('#search-result').removeClass('d-none');
                        }
                    },
                    error: function() {
                        $('#search-list').html('<li class="list-group-item">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</li>');
                        $('#search-result').removeClass('d-none');
                    }
                });
            });

            // æœç´¢ç»“æœç‚¹å‡»è§£æ
            $(document).on('click', '.select-song', function() {
                const songId = $(this).data('id');
                $('#song_ids').val(songId);
                // åˆ‡æ¢åˆ°å•æ›²è§£ææ ‡ç­¾é¡µ
                if (typeof activateTab === 'function') {
                    activateTab('parse');
                } else {
                    // å…¼å®¹ç«‹å³è°ƒç”¨çš„æƒ…å†µ
                    document.querySelectorAll('.tab-item').forEach(tab => {
                        if (tab.getAttribute('data-mode') === 'parse') {
                            tab.click();
                        }
                    });
                }
                $('html,body').animate({scrollTop: $('#main-form').offset().top}, 300);
            });

            // å•æ›²è§£æ
            $('#parse-btn').on('click', function() {
                const songIds = $('#song_ids').val();
                const level = $('#level').val();
                ml_get_song_info_real_url = ml_song_info_post_url_base + '/Song_V1';
                if (!songIds) {
                    alert('è¯·è¾“å…¥æ­Œæ›²IDæˆ–URL');
                    return;
                }
                $.post(ml_get_song_info_real_url, { url: songIds, level: level, type:'json' }, function(data) {
                    console.log("å•æ›²è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        $('#song_name').text(data.name);
                        $('#artist_names').text(data.ar_name);
                        $('#song_alname').text(data.al_name);
                        $('#song_level').text(data.level);
                        $('#song_size').text(data.size);
                        let processedLyrics = data.lyric;
                        if (data.tlyric) {
                            processedLyrics = lrctran(data.lyric, data.tlyric);
                        }
                        $('#lyric').html(processedLyrics.replace(/\n/g, '<br>'));
                        $('#song_url').attr('href', data.url).text('ç‚¹å‡»ä¸‹è½½mp3');
                        $('#song-info').removeClass('d-none');
                        $('#show-big-pic').data('pic', data.pic);
                        ap.list.clear();
                        ml_first_song_detailed_info = {
                            id: data.id,
                            name: data.name,
                            artist: data.ar_name,
                            url: data.url,
                            cover: data.pic,
                            lrc: processedLyrics
                        };
                        ap.list.add(ml_first_song_detailed_info);
                        document.querySelector('.aplayer-notice').style.opacity = '0';
                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#downloadMusicButton').on('click', function() {
                            ml_music_download(
                                data.al_name,
                                data.ar_name,
                                processedLyrics,
                                data.name,
                                data.pic,
                                data.url
                            );
                        });
                    } else {
                        alert(data.msg);
                    }
                }, 'json');
            });

            // æ˜¾ç¤ºå¤§å›¾æŒ‰é’®äº‹ä»¶
            $(document).on('click', '#show-big-pic', function() {
                var picUrl = $(this).data('pic');
                $('#big-pic-img').attr('src', picUrl);
                var modal = new bootstrap.Modal(document.getElementById('bigPicModal'));
                modal.show();
            });

            // æ­Œå•è§£æ
            $('#playlist-btn').on('click', function() {
                let pid = $('#playlist_id').val().trim();
                ml_get_playlist_real_url = ml_song_info_post_url_base + '/Playlist';
                if (!pid) {
                    alert('è¯·è¾“å…¥æ­Œå•IDæˆ–é“¾æ¥');
                    return;
                }
                // æ”¯æŒç›´æ¥ç²˜è´´æ­Œå•é“¾æ¥
                const idMatch = pid.match(/playlist\?id=(\d+)/);
                if (idMatch) pid = idMatch[1];
                $.get(ml_get_playlist_real_url, { id: pid }, function(data) {
                    console.log("æ­Œå•è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        ml_song_list.length = 0;
                        const pl = data.playlist;
                        $('#playlist-cover').attr('src', pl.coverImgUrl);
                        $('#playlist-name').text(pl.name);
                        $('#playlist-creator').text('by ' + pl.creator);
                        $('#playlist-desc').text(pl.description || '');
                        $('#playlist-count').text(pl.trackCount);
                        $('#playlist-tracks').empty();
                        pl.tracks.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <img src="${song.picUrl}" alt="cover" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è§£æ</button>
                            </li>`;
                            ml_song_list.push(song);
                            $('#playlist-tracks').append(item);
                        });
                        $('#playlist-result').removeClass('d-none');
                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#download_all_MusicButton_playlist').off('click').on('click', function() {
                            ml_donwload_song_list($('#level').val());
                        });
                        // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#play_all_playlist').off('click').on('click', function() {
                            add_all_song_info_to_aplayer($('#level').val());
                        });
                    } else {
                        $('#playlist-result').removeClass('d-none');
                        $('#playlist-tracks').html('<li class="list-group-item">æ­Œå•è§£æå¤±è´¥ï¼š'+data.msg+'</li>');
                    }
                }, 'json');
            });

            // ä¸“è¾‘è§£æ
            $(document).on('click', '#album-btn', function() {
                let aid = $('#album_id').val().trim();
                ml_get_album_real_url = ml_song_info_post_url_base + '/Album';
                if (!aid) {
                    alert('è¯·è¾“å…¥ä¸“è¾‘IDæˆ–é“¾æ¥');
                    return;
                }
                // æ”¯æŒç›´æ¥ç²˜è´´ä¸“è¾‘é“¾æ¥
                const idMatch = aid.match(/album\?id=(\d+)/);
                if (idMatch) aid = idMatch[1];
                $.get(ml_get_album_real_url, { id: aid }, function(data) {
                    console.log("ä¸“è¾‘è§£æ");
                    console.log(data);
                    if (data.status === 200) {
                        ml_song_list.length = 0;
                        const al = data.album;
                        $('#album-cover').attr('src', al.coverImgUrl);
                        $('#album-name').text(al.name);
                        $('#album-artist').text(al.artist);
                        $('#album-desc').text(al.description || '');
                        $('#album-count').text(al.songs.length);
                        $('#album-tracks').empty();
                        al.songs.forEach(function(song, idx) {
                            const item = `<li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <img src="${song.picUrl}" alt="cover" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;">
                                    <strong class="playlist-title">${idx+1}. ${song.name}</strong> - <span>${song.artists}</span> <span class="text-muted">[${song.album}]</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary select-song" data-id="${song.id}" data-name="${song.name}">è§£æ</button>
                            </li>`;
                            ml_song_list.push(song);
                            $('#album-tracks').append(item);
                        });
                        $('#album-result').removeClass('d-none');
                        // ä¸ºä¸‹è½½æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#download_all_MusicButton_album').off('click').on('click', function() {
                            ml_donwload_song_list($('#level').val());
                        });
                        // ä¸ºå…¨éƒ¨æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        $('#play_all_album').off('click').on('click', function() {
                            add_all_song_info_to_aplayer($('#level').val());
                        });
                    } else {
                        $('#album-result').removeClass('d-none');
                        $('#album-tracks').html('<li class="list-group-item">ä¸“è¾‘è§£æå¤±è´¥ï¼š'+data.msg+'</li>');
                    }
                }, 'json');
            });
            
            // fetch all detailed info
            // and then add to aplayer playlist
            // first remove all existing songs in playlist
            async function add_all_song_info_to_aplayer(ml_selected_level){
                ap.notice('Started: dynamically adding songs', 3000, 0.8);
                console.log('Started: dynamically adding songs\n', ml_song_list);
                ml_get_song_info_real_url = ml_song_info_post_url_base + '/Song_V1';
                ap.list.clear();
                for(const song of ml_song_list){
                    let currentTry = 0;
                    let songAdded = false;
                    let response = null;
                    while(currentTry <= ml_max_try_times && !songAdded){
                        try {
                            console.log(`å°è¯•è·å–æ­Œæ›²ä¿¡æ¯ï¼š${song.name} (å°è¯•æ¬¡æ•°: ${currentTry + 1}/${ml_max_try_times + 1})`);
                            response = await $.post(ml_get_song_info_real_url, { url: song.id, level: ml_selected_level, type: 'json' });
                            if(response.status === 200){
                                console.log(`æˆåŠŸè·å–æ­Œæ›²ä¿¡æ¯ï¼š${song.name}\n`, response);
                                songAdded = true;
                            } else {
                                console.error(`è·å–æ­Œæ›² ${song.name} å¤±è´¥ (å°è¯• ${currentTry + 1}/${ml_max_try_times + 1}): ${response.msg}`);
                                currentTry++;
                                // å¯é€‰ï¼šå»¶è¿Ÿï¼Œé¿å…é«˜é¢‘è¯·æ±‚
                                // await sleep(1000);
                            }
                        } catch(error) {
                            console.error(`è¯·æ±‚æ­Œæ›² ${song.name} æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯æˆ–å¼‚å¸¸ (å°è¯• ${currentTry + 1}/${ml_max_try_times + 1}):`, error);
                            currentTry++;
                            // å¯é€‰ï¼šå»¶è¿Ÿ
                            // await sleep(1000);
                        }
                    }
                    if(songAdded && response){
                        let processedLyrics = response.lyric;
                        if(response.tlyric){
                            processedLyrics = lrctran(response.lyric, response.tlyric);
                        }
                        ml_song_detailed = {
                            id: song.id,
                            name: response.name,
                            artist: response.ar_name,
                            url: response.url,
                            cover: response.pic,
                            lrc: processedLyrics
                        };
                        ap.list.add(ml_song_detailed);
                        console.log(`æ­Œæ›² ${song.name} å·²æˆåŠŸæ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ã€‚`);
                    } else {
                        console.warn(`æ­Œæ›² ${song.name} è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (${ml_max_try_times + 1} æ¬¡) ä»æœªæˆåŠŸï¼Œå·²è·³è¿‡ã€‚`);
                    }
                }
                console.log(ap.list);
                ap.notice('Fininshed: dynamically adding songs', 3000, 0.8);
                console.log('Fininshed: dynamically adding songs');
            }
            // å¯é€‰ï¼šsleep è¾…åŠ©å‡½æ•°
            // async function sleep(ms) {
            //     return new Promise(resolve => setTimeout(resolve, ms));
            // }
        });
    </script>
</body>
</html>
